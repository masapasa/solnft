{"version":3,"file":"createTokenWithMint.mjs","sources":["../../../../../src/plugins/tokenModule/operations/createTokenWithMint.ts"],"sourcesContent":["import type { Metaplex } from '@/Metaplex';\nimport {\n  isSigner,\n  Operation,\n  OperationHandler,\n  Signer,\n  SplTokenAmount,\n  toPublicKey,\n  useOperation,\n} from '@/types';\nimport { DisposableScope, Option, TransactionBuilder } from '@/utils';\nimport { ConfirmOptions, Keypair, PublicKey } from '@solana/web3.js';\nimport { SendAndConfirmTransactionResponse } from '../../rpcModule';\nimport { MintAuthorityMustBeSignerToMintInitialSupplyError } from '../errors';\nimport { TokenWithMint } from '../models/Token';\n\n// -----------------\n// Operation\n// -----------------\n\nconst Key = 'CreateTokenWithMintOperation' as const;\n\n/**\n * Creates both mint and token accounts in the same transaction.\n *\n * ```ts\n * const { token } = await metaplex.tokens().createTokenWithMint().run();\n * const mint = token.mint;\n * ```\n *\n * @group Operations\n * @category Constructors\n */\nexport const createTokenWithMintOperation =\n  useOperation<CreateTokenWithMintOperation>(Key);\n\n/**\n * @group Operations\n * @category Types\n */\nexport type CreateTokenWithMintOperation = Operation<\n  typeof Key,\n  CreateTokenWithMintInput,\n  CreateTokenWithMintOutput\n>;\n\n/**\n * @group Operations\n * @category Inputs\n */\nexport type CreateTokenWithMintInput = {\n  /**\n   * The number of decimal points used to define token amounts.\n   *\n   * @defaultValue `0`\n   */\n  decimals?: number;\n\n  /**\n   * The initial amount of tokens to mint to the new token account.\n   *\n   * @defaultValue `0`\n   */\n  initialSupply?: SplTokenAmount;\n\n  /**\n   * The address of the new mint account as a Signer.\n   *\n   * @defaultValue `Keypair.generate()`\n   */\n  mint?: Signer;\n\n  /**\n   * The address of the authority that is allowed\n   * to mint new tokens to token accounts.\n   *\n   * It may be required as a Signer in order to\n   * mint the initial supply.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  mintAuthority?: Signer | PublicKey;\n\n  /**\n   * The address of the authority that is allowed\n   * to freeze token accounts.\n   *\n   * @defaultValue `metaplex.identity().publicKey`\n   */\n  freezeAuthority?: Option<PublicKey>;\n\n  /**\n   * The address of the owner of the new token account.\n   *\n   * @defaultValue `metaplex.identity().publicKey`\n   */\n  owner?: PublicKey;\n\n  /**\n   * The token account as a Signer if we want to create\n   * a new token account with a specific address instead of\n   * creating a new associated token account.\n   *\n   * @defaultValue Defaults to creating a new associated token account\n   * using the `mint` and `owner` parameters.\n   */\n  token?: Signer;\n\n  /**\n   * The Signer paying for the new mint and token accounts\n   * and for the transaction fee.\n   *\n   * @defaultValue `metaplex.identity()`\n   */\n  payer?: Signer;\n\n  /** The address of the SPL Token program to override if necessary. */\n  tokenProgram?: PublicKey;\n\n  /** The address of the SPL Associated Token program to override if necessary. */\n  associatedTokenProgram?: PublicKey;\n\n  /** A set of options to configure how the transaction is sent and confirmed. */\n  confirmOptions?: ConfirmOptions;\n};\n\n/**\n * @group Operations\n * @category Outputs\n */\nexport type CreateTokenWithMintOutput = {\n  /** The blockchain response from sending and confirming the transaction. */\n  response: SendAndConfirmTransactionResponse;\n\n  /** The new mint account as a Signer. */\n  mintSigner: Signer;\n\n  /**\n   * A model representing the newly created token\n   * account and its associated mint account.\n   */\n  token: TokenWithMint;\n};\n\n/**\n * @group Operations\n * @category Handlers\n */\nexport const createTokenWithMintOperationHandler: OperationHandler<CreateTokenWithMintOperation> =\n  {\n    async handle(\n      operation: CreateTokenWithMintOperation,\n      metaplex: Metaplex,\n      scope: DisposableScope\n    ): Promise<CreateTokenWithMintOutput> {\n      const builder = await createTokenWithMintBuilder(\n        metaplex,\n        operation.input\n      );\n      scope.throwIfCanceled();\n\n      const output = await builder.sendAndConfirm(\n        metaplex,\n        operation.input.confirmOptions\n      );\n      scope.throwIfCanceled();\n\n      const token = await metaplex\n        .tokens()\n        .findTokenWithMintByMint({\n          mint: output.mintSigner.publicKey,\n          address: output.tokenAddress,\n          addressType: 'token',\n        })\n        .run(scope);\n\n      return { ...output, token };\n    },\n  };\n\n// -----------------\n// Builder\n// -----------------\n\n/**\n * @group Transaction Builders\n * @category Inputs\n */\nexport type CreateTokenWithMintBuilderParams = Omit<\n  CreateTokenWithMintInput,\n  'confirmOptions'\n> & {\n  /** A key to distinguish the instruction that creates the mint account. */\n  createMintAccountInstructionKey?: string;\n\n  /** A key to distinguish the instruction that initializes the mint account. */\n  initializeMintInstructionKey?: string;\n\n  /** A key to distinguish the instruction that creates the associates token account. */\n  createAssociatedTokenAccountInstructionKey?: string;\n\n  /** A key to distinguish the instruction that creates the token account. */\n  createTokenAccountInstructionKey?: string;\n\n  /** A key to distinguish the instruction that initializes the token account. */\n  initializeTokenInstructionKey?: string;\n\n  /** A key to distinguish the instruction that mints tokens to the token account. */\n  mintTokensInstructionKey?: string;\n};\n\n/**\n * @group Transaction Builders\n * @category Contexts\n */\nexport type CreateTokenWithMintBuilderContext = {\n  /** The mint account to create as a Signer. */\n  mintSigner: Signer;\n\n  /** The computed address of the token account to create. */\n  tokenAddress: PublicKey;\n};\n\n/**\n * Creates both mint and token accounts in the same transaction.\n *\n * ```ts\n * const transactionBuilder = await metaplex.tokens().builders().createTokenWithMint();\n * ```\n *\n * @group Transaction Builders\n * @category Constructors\n */\nexport const createTokenWithMintBuilder = async (\n  metaplex: Metaplex,\n  params: CreateTokenWithMintBuilderParams\n): Promise<TransactionBuilder<CreateTokenWithMintBuilderContext>> => {\n  const {\n    decimals = 0,\n    initialSupply,\n    mint = Keypair.generate(),\n    mintAuthority = metaplex.identity(),\n    freezeAuthority = metaplex.identity().publicKey,\n    owner = metaplex.identity().publicKey,\n    token,\n    payer = metaplex.identity(),\n    tokenProgram,\n    associatedTokenProgram,\n  } = params;\n\n  const createMintBuilder = await metaplex\n    .tokens()\n    .builders()\n    .createMint({\n      decimals,\n      mint,\n      payer,\n      mintAuthority: toPublicKey(mintAuthority),\n      freezeAuthority,\n      tokenProgram,\n      createAccountInstructionKey:\n        params.createMintAccountInstructionKey ?? 'createMintAccount',\n      initializeMintInstructionKey:\n        params.initializeMintInstructionKey ?? 'initializeMint',\n    });\n\n  const createTokenBuilder = await metaplex\n    .tokens()\n    .builders()\n    .createToken({\n      mint: mint.publicKey,\n      owner,\n      token,\n      payer,\n      tokenProgram,\n      associatedTokenProgram,\n      createAssociatedTokenAccountInstructionKey:\n        params.createAssociatedTokenAccountInstructionKey ??\n        'createAssociatedTokenAccount',\n      createAccountInstructionKey:\n        params.createTokenAccountInstructionKey ?? 'createTokenAccount',\n      initializeTokenInstructionKey:\n        params.initializeTokenInstructionKey ?? 'initializeToken',\n    });\n\n  const { tokenAddress } = createTokenBuilder.getContext();\n\n  const builder = TransactionBuilder.make<CreateTokenWithMintBuilderContext>()\n    .setFeePayer(payer)\n    .setContext({ mintSigner: mint, tokenAddress })\n\n    // Create the Mint account.\n    .add(createMintBuilder)\n\n    // Create the Token account.\n    .add(createTokenBuilder);\n\n  // Potentially mint the initial supply to the token account.\n  if (!!initialSupply) {\n    if (!isSigner(mintAuthority)) {\n      throw new MintAuthorityMustBeSignerToMintInitialSupplyError();\n    }\n\n    builder.add(\n      await metaplex\n        .tokens()\n        .builders()\n        .mint({\n          mintAddress: mint.publicKey,\n          toToken: tokenAddress,\n          amount: initialSupply,\n          mintAuthority,\n          tokenProgram,\n          mintTokensInstructionKey:\n            params.mintTokensInstructionKey ?? 'mintTokens',\n        })\n    );\n  }\n\n  return builder;\n};\n"],"names":["Key","createTokenWithMintOperation","useOperation","createTokenWithMintOperationHandler","handle","operation","metaplex","scope","builder","createTokenWithMintBuilder","input","throwIfCanceled","output","sendAndConfirm","confirmOptions","token","tokens","findTokenWithMintByMint","mint","mintSigner","publicKey","address","tokenAddress","addressType","run","params","decimals","initialSupply","Keypair","generate","mintAuthority","identity","freezeAuthority","owner","payer","tokenProgram","associatedTokenProgram","createMintBuilder","builders","createMint","toPublicKey","createAccountInstructionKey","createMintAccountInstructionKey","initializeMintInstructionKey","createTokenBuilder","createToken","createAssociatedTokenAccountInstructionKey","createTokenAccountInstructionKey","initializeTokenInstructionKey","getContext","TransactionBuilder","make","setFeePayer","setContext","add","isSigner","MintAuthorityMustBeSignerToMintInitialSupplyError","mintAddress","toToken","amount","mintTokensInstructionKey"],"mappings":"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"}